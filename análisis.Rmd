---
title: "Red de Aportantes"
author: "andrés castro araújo"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
  html_document: 
    theme: lumen
    toc: yes
    toc_float: 
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", fig.align = "center")

library(tidyverse)
theme_set(theme_minimal(base_family = "Avenir", base_line_size = 0))

```

```{r}
df <- read_csv("red_de_aportantes.csv")
```

El primer paso es revisar que los datos estén bien usando `View()`. Haciendo esto podemos ver que algunos aportantes están en sólo minúsculas, otros en mayúsculas, y en otros hay inconsistencia con las tildes.

Entonces hay que limpiar los datos un poco más.

```{r}
df <- df %>% 
  mutate_if(is.character, str_to_lower) %>% ## todo a minúsculas
  mutate_if(is.character, stringi::stri_trans_general, id = "Latin-ASCII") ## tildes


df <- df %>% 
  group_by(de, para, parentesco) %>% 
  summarise(valor = sum(valor)) %>% 
  arrange(desc(valor))

df %>% mutate(valor = scales::dollar(valor))
```


```{r}
library(ggraph)
library(igraph)

mat <- df %>% 
  count(de, para) %>% 
  tidytext::cast_sparse(row = de, column = para, value = n) %>% 
  as.matrix()

adj_mat <- t(mat) %*% mat 

igraph::graph_from_adjacency_matrix(adj_mat, weighted = TRUE, diag = FALSE) %>% 
  igraph::as.undirected() %>% 
  ggraph("kk") +
  geom_node_point() +
  geom_edge_fan(aes(width = weight, color = weight), 
                alpha = 0.2, show.legend = FALSE) +
  geom_node_text(aes(label = str_trunc(name, 8, ellipsis = "")))
```



Quien tiene el mayor número de aportantes y cuánto lograron recolectar?

```{r}
df %>% 
  group_by(para) %>% 
  summarize(n = n(), valor = sum(valor)) %>% 
  arrange(desc(valor)) %>% 
  mutate(valor = scales::dollar(valor))
```



Por hacer:

Volver a las funciones y extraer cédulas y nits.
